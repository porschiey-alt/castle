<div class="message-bubble" [class.user]="isUser" [class.agent]="!isUser" [class.streaming]="isStreaming()" [class.processing]="isProcessing">
  <!-- Avatar -->
  <div class="avatar">
    @if (isUser) {
      <mat-icon>person</mat-icon>
    } @else if (agentIcon()) {
      <span class="agent-icon">{{ agentIcon() }}</span>
    } @else {
      <mat-icon>smart_toy</mat-icon>
    }
  </div>

  <!-- Message content -->
  <div class="message-content">
    <div class="message-header">
      <span class="sender-name">{{ isUser ? 'You' : agentName() }}</span>
      @if (timestamp) {
        <span class="timestamp">{{ timestamp | date:'shortTime' }}</span>
      }
    </div>

    <!-- Interleaved segments (streaming with segment data, or historical with saved segments) -->
    @if (hasSegments) {
      @for (segment of resolvedSegments; track $index) {
        @if (segment.type === 'tool-calls') {
          <div class="tool-calls-list">
            @if (segment.hiddenCount > 0) {
              <div class="tool-calls-collapsed">
                <mat-icon>more_horiz</mat-icon>
                <span>{{ segment.hiddenCount }} earlier tool call{{ segment.hiddenCount > 1 ? 's' : '' }}</span>
              </div>
            }
            @for (tool of segment.visibleToolCalls; track tool.id) {
              <div class="tool-call-item" [class]="'tool-' + tool.status">
                <mat-icon class="tool-status-icon">
                  @switch (tool.status) {
                    @case ('pending') { hourglass_empty }
                    @case ('running') { sync }
                    @case ('success') { check_circle }
                    @case ('error') { error }
                  }
                </mat-icon>
                <span class="tool-name">{{ tool.name }}</span>
              </div>
            }
          </div>
        } @else {
          <div class="message-body">
            @for (part of segment.parsedContent; track $index) {
              @if (part.type === 'text') {
                <div class="text-content" [innerHTML]="renderMarkdown(part.content)"></div>
              } @else {
                <app-code-block
                  [code]="part.content"
                  [language]="part.language || 'plaintext'"
                />
              }
            }
          </div>
        }
      }
      @if (isStreaming()) {
        <span class="cursor">▊</span>
      }
    } @else {
      <!-- Legacy layout: tool calls then content (non-streaming / historical messages) -->
      @if (activeToolCalls.length > 0) {
        <div class="tool-calls-list">
          @if (hiddenToolCallCount > 0) {
            <div class="tool-calls-collapsed">
              <mat-icon>more_horiz</mat-icon>
              <span>{{ hiddenToolCallCount }} earlier tool call{{ hiddenToolCallCount > 1 ? 's' : '' }}</span>
            </div>
          }
          @for (tool of visibleToolCalls; track tool.id) {
            <div class="tool-call-item" [class]="'tool-' + tool.status">
              <mat-icon class="tool-status-icon">
                @switch (tool.status) {
                  @case ('pending') { hourglass_empty }
                  @case ('running') { sync }
                  @case ('success') { check_circle }
                  @case ('error') { error }
                }
              </mat-icon>
              <span class="tool-name">{{ tool.name }}</span>
            </div>
          }
        </div>
      }

      @if (content) {
        <div class="message-body">
          @for (part of parsedContent; track $index) {
            @if (part.type === 'text') {
              <div class="text-content" [innerHTML]="renderMarkdown(part.content)"></div>
            } @else {
              <app-code-block
                [code]="part.content"
                [language]="part.language || 'plaintext'"
              />
            }
          }

          @if (isStreaming()) {
            <span class="cursor">▊</span>
          }
        </div>
      } @else if (isStreaming()) {
        <!-- Processing indicator when no content yet -->
        <div class="processing-indicator">
          <div class="processing-shimmer"></div>
        </div>
      }
    }
  </div>
</div>
