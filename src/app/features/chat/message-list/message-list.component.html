<div class="message-list-container" #scrollContainer (scroll)="onScroll()">
  <div class="messages-wrapper">
    @for (message of messages(); track trackByMessageId($index, message)) {
      @if (hasVisibleContent(message)) {
        <app-message-bubble
          [message]="message"
          [agentName]="agentName()"
          [agentIcon]="agentIcon()"
        />
      }
    } @empty {
      <div class="empty-state">
        <p>No messages yet. Start a conversation!</p>
      </div>
    }

    @if (streamingMessage(); as streaming) {
      <!-- Streaming message (segments + content, no thinking) -->
      @if (hasStreamingContent(streaming)) {
        <app-message-bubble
          [streamingContent]="streaming.content"
          [streamingToolCalls]="streaming.toolCalls"
          [streamingSegments]="streaming.segments"
          [isStreaming]="true"
          [agentName]="agentName()"
          [agentIcon]="agentIcon()"
        />
      }

      <!-- Thinking bubble always at bottom -->
      @if (latestThinking()) {
        <div class="thinking-bubble">
          <div class="avatar">
            <app-agent-icon [icon]="agentIcon()" />
          </div>
          <div class="thinking-content">
            <mat-icon class="thinking-pulse-icon">psychology</mat-icon>
            <span class="thinking-text" [innerHTML]="renderThinking(latestThinking())"></span>
          </div>
        </div>
      }
    }
  </div>
</div>
