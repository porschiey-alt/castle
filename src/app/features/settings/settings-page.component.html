<div class="settings-page">
  <div class="settings-header">
    <mat-icon>settings</mat-icon>
    <h2>Settings</h2>
  </div>

  <div class="settings-sections">
    <!-- Theme Preset Section -->
    <section class="settings-section">
      <h3>
        <mat-icon>palette</mat-icon>
        Theme Preset
      </h3>
      <p class="section-description">Choose a base theme, then customize colors below.</p>
      <div class="theme-grid">
        @for (theme of availableThemes; track theme.id) {
          <button class="theme-card" [class.active]="currentTheme().id === theme.id" (click)="setTheme(theme.id)">
            <div class="theme-preview" [style.background]="theme.bgPrimary || '#ffffff'">
              <div class="theme-swatch" [style.background]="theme.primary"></div>
            </div>
            <span class="theme-name">{{ theme.name }}</span>
            @if (currentTheme().id === theme.id) {
              <mat-icon class="theme-check">check_circle</mat-icon>
            }
          </button>
        }
      </div>
    </section>

    <mat-divider />

    <!-- Custom Colors Section -->
    <section class="settings-section">
      <h3>
        <mat-icon>tune</mat-icon>
        Customize Colors
      </h3>
      <p class="section-description">
        Adjust background, accent, and secondary accent colors. The secondary accent is used for tabs and highlights. Text color is automatically calculated for readability.
      </p>

      <div class="color-controls">
        <!-- Background Color -->
        <div class="color-row">
          <label class="color-label">
            <mat-icon>format_color_fill</mat-icon>
            Background
          </label>
          <div class="color-input-group">
            <input
              type="color"
              class="color-picker"
              [(ngModel)]="customBgPrimary"
              (ngModelChange)="onCustomizationChange()"
            />
            <input
              type="text"
              class="color-hex"
              [(ngModel)]="customBgPrimary"
              (ngModelChange)="onCustomizationChange()"
              maxlength="7"
              placeholder="#0a0a0a"
            />
          </div>
        </div>

        <!-- Accent Color -->
        <div class="color-row">
          <label class="color-label">
            <mat-icon>colorize</mat-icon>
            Accent
          </label>
          <div class="color-input-group">
            <input
              type="color"
              class="color-picker"
              [(ngModel)]="customAccentColor"
              (ngModelChange)="onCustomizationChange()"
            />
            <input
              type="text"
              class="color-hex"
              [(ngModel)]="customAccentColor"
              (ngModelChange)="onCustomizationChange()"
              maxlength="7"
              placeholder="#6366f1"
            />
          </div>
        </div>

        <!-- Secondary Accent Color -->
        <div class="color-row">
          <label class="color-label">
            <mat-icon>auto_awesome</mat-icon>
            Secondary Accent
          </label>
          <div class="color-input-group">
            <input
              type="color"
              class="color-picker"
              [(ngModel)]="customSecondaryAccentColor"
              (ngModelChange)="onCustomizationChange()"
            />
            <input
              type="text"
              class="color-hex"
              [(ngModel)]="customSecondaryAccentColor"
              (ngModelChange)="onCustomizationChange()"
              maxlength="7"
              placeholder="#a855f7"
            />
          </div>
        </div>

        <!-- Gradient Toggle -->
        <div class="color-row">
          <label class="color-label">
            <mat-icon>gradient</mat-icon>
            Background Gradient
          </label>
          <mat-slide-toggle
            [(ngModel)]="gradientEnabled"
            (change)="onCustomizationChange()">
          </mat-slide-toggle>
        </div>

        <!-- Gradient Options (shown when enabled) -->
        @if (gradientEnabled) {
          <div class="gradient-options">
            <div class="color-row">
              <label class="color-label">
                <mat-icon>color_lens</mat-icon>
                Gradient End Color
              </label>
              <div class="color-input-group">
                <input
                  type="color"
                  class="color-picker"
                  [(ngModel)]="gradientEndColor"
                  (ngModelChange)="onCustomizationChange()"
                />
                <input
                  type="text"
                  class="color-hex"
                  [(ngModel)]="gradientEndColor"
                  (ngModelChange)="onCustomizationChange()"
                  maxlength="7"
                  placeholder="#1a1a2e"
                />
              </div>
            </div>

            <div class="color-row">
              <label class="color-label">
                <mat-icon>north_east</mat-icon>
                Direction
              </label>
              <mat-form-field appearance="outline" class="direction-field">
                <mat-select [(ngModel)]="gradientDirection" (ngModelChange)="onCustomizationChange()">
                  @for (dir of gradientDirections; track dir.value) {
                    <mat-option [value]="dir.value">{{ dir.label }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        }
      </div>

      <!-- Preview -->
      <div class="theme-preview-card">
        <span class="preview-label">Preview</span>
        <div class="preview-box" [style.background]="getGradientPreview()">
          <span class="preview-text" [style.color]="getAutoTextColor()">Sample Text</span>
          <span class="preview-accent" [style.background]="customSecondaryAccentColor">Secondary</span>
          <span class="preview-accent" [style.background]="customAccentColor">Accent</span>
        </div>
        <div class="contrast-info">
          <mat-icon>visibility</mat-icon>
          <span>Text contrast ratio: <strong>{{ getContrastRatio() }}:1</strong></span>
          <span class="contrast-badge" [class.good]="getContrastRatio() >= '4.5'" [class.poor]="getContrastRatio() < '4.5'">
            {{ getContrastRatio() >= '4.5' ? 'AA Pass' : 'Low' }}
          </span>
        </div>
      </div>

      <button mat-stroked-button class="reset-btn" (click)="resetCustomization()">
        <mat-icon>restart_alt</mat-icon>
        Reset to Preset Defaults
      </button>
    </section>

    <mat-divider />

    <!-- Remote Access Section (only shown on local Electron app, not remote browsers) -->
    @if (isElectron) {
    <section class="settings-section">
      <h3>
        <mat-icon>lan</mat-icon>
        Remote Access
      </h3>
      <p class="section-description">
        Serve the Castle UI over HTTP so you can access it from other devices on your network or Tailscale tailnet.
      </p>

      <div class="setting-row">
        <div class="setting-label">
          <span>Enable remote access</span>
        </div>
        <mat-slide-toggle
          [(ngModel)]="tailscaleEnabled"
          (change)="onToggle()"
          [disabled]="saving">
        </mat-slide-toggle>
      </div>

      @if (tailscaleEnabled) {
        <div class="setting-row port-row">
          <mat-form-field appearance="outline" class="port-field">
            <mat-label>Port</mat-label>
            <input matInput type="number" [(ngModel)]="tailscalePort" min="1024" max="65535">
          </mat-form-field>
          <button mat-stroked-button (click)="applyPort()" [disabled]="saving">
            Apply
          </button>
        </div>

        <div class="status-row">
          @if (tailscaleRunning) {
            <mat-icon class="status-icon running">check_circle</mat-icon>
            <span class="status-text running">
              Running on <code>http://localhost:{{ tailscalePort }}</code>
            </span>
          } @else {
            <mat-icon class="status-icon stopped">radio_button_unchecked</mat-icon>
            <span class="status-text stopped">Not running</span>
          }
        </div>

        @if (tailscaleError) {
          <div class="error-row">
            <mat-icon>error</mat-icon>
            <span>{{ tailscaleError }}</span>
          </div>
        }
      }
    </section>
    }

    <mat-divider />

    <!-- Git Worktree Section -->
    <section class="settings-section">
      <h3>
        <mat-icon>account_tree</mat-icon>
        Git Worktrees
      </h3>
      <p class="section-description">
        Agent implementation tasks use git worktrees for branch isolation. Each task gets its own working directory.
      </p>

      <div class="setting-row">
        <div class="setting-label">
          <span>Enable worktrees</span>
          <span class="setting-hint">When disabled, agents work directly in your main directory</span>
        </div>
        <mat-slide-toggle
          [(ngModel)]="worktreeEnabled"
          (change)="saveWorktreeSettings()">
        </mat-slide-toggle>
      </div>

      @if (worktreeEnabled) {
        <div class="setting-row">
          <div class="setting-label">
            <span>Max concurrent worktrees</span>
            <span class="setting-hint">Limit how many worktrees can exist at once (each uses disk space)</span>
          </div>
          <mat-form-field appearance="outline" class="small-field">
            <input matInput type="number" [(ngModel)]="worktreeMaxConcurrent" min="1" max="20"
                   (change)="saveWorktreeSettings()">
          </mat-form-field>
        </div>

        <div class="setting-row">
          <div class="setting-label">
            <span>Auto-install dependencies</span>
            <span class="setting-hint">Run npm/yarn/pnpm install in new worktrees</span>
          </div>
          <mat-slide-toggle
            [(ngModel)]="worktreeAutoInstallDeps"
            (change)="saveWorktreeSettings()">
          </mat-slide-toggle>
        </div>

        <div class="setting-row">
          <div class="setting-label">
            <span>Create PRs as drafts</span>
            <span class="setting-hint">Mark auto-created pull requests as drafts</span>
          </div>
          <mat-slide-toggle
            [(ngModel)]="worktreeDraftPR"
            (change)="saveWorktreeSettings()">
          </mat-slide-toggle>
        </div>
      }
    </section>

    <mat-divider />

    <!-- Permissions Section -->
    <section class="settings-section">
      <h3>
        <mat-icon>security</mat-icon>
        Permissions
      </h3>
      <p class="section-description">
        Manage persisted permission grants for the current project.
        These are saved when you select "Always allow" or "Always reject" on a permission prompt.
      </p>

      @if (!currentProjectPath) {
        <div class="empty-state">
          <mat-icon>folder_off</mat-icon>
          <span>No project open. Open a project to manage its permissions.</span>
        </div>
      } @else if (permissionGrants.length === 0) {
        <div class="empty-state">
          <mat-icon>check_circle</mat-icon>
          <span>No persisted permission grants for this project.</span>
        </div>
      } @else {
        <div class="grants-list">
          @for (grant of permissionGrants; track grant.id) {
            <div class="grant-row">
              <div class="grant-info">
                <mat-icon class="grant-icon">{{ getGrantIcon(grant.toolKind) }}</mat-icon>
                <div class="grant-details">
                  <span class="grant-kind">{{ grant.toolKind }}</span>
                  <span class="grant-status" [class.allowed]="grant.granted" [class.rejected]="!grant.granted">
                    {{ grant.granted ? 'Always allowed' : 'Always rejected' }}
                  </span>
                </div>
              </div>
              <button mat-icon-button (click)="deleteGrant(grant)" matTooltip="Revoke">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          }
        </div>
        <button mat-stroked-button class="revoke-all-btn" (click)="deleteAllGrants()">
          <mat-icon>delete_sweep</mat-icon>
          Revoke All
        </button>
      }
    </section>

    <mat-divider />

    <!-- About Section -->
    <section class="settings-section about-section">
      <h3>
        <mat-icon>info</mat-icon>
        About
      </h3>
      <div class="about-card">
        <span class="app-logo">üè∞</span>
        <div class="about-info">
          <span class="app-title">{{ appName }}</span>
          <span class="app-version">Version {{ appVersion }}</span>
        </div>
      </div>
      <p class="section-description">
        A Discord-like desktop app for GitHub Copilot CLI agents.
        Manage multiple AI agents, each with their own personality and capabilities.
      </p>
    </section>
  </div>
</div>
