<div class="tasks-container">
  @if (creating) {
    <!-- Full-screen create view -->
    <app-task-detail
      [labels]="labels()"
      [startEditing]="true"
      (saved)="onSave(null, $event)"
      (closed)="deselectTask()"
    />
  } @else {
    @if (selectedTask(); as task) {
      <!-- Detail / inline-edit view -->
      <app-task-detail
        [task]="task"
        [labels]="labels()"
        [agents]="agents()"
        [researchRunning]="taskService.isResearchRunning(task.id)"
        [implementRunning]="taskService.isImplementRunning(task.id)"
        [reviewRunning]="taskService.isReviewRunning(task.id)"
        [githubAvailable]="githubAvailable"
        (saved)="onSave(task.id, $event)"
        (deleteRequested)="deleteTask($event)"
        (stateChanged)="onStateChange($event)"
        (researchRequested)="onResearchRequested($event)"
        (implementRequested)="onImplementRequested($event)"
        (createPRRequested)="onCreatePR($event)"
        (diffLoadRequested)="onDiffLoadRequested($event)"
        (reviewSubmitted)="onReviewSubmitted($event)"
        (pushToGitHubRequested)="onPushToGitHub($event)"
        (unlinkFromGitHubRequested)="onUnlinkFromGitHub($event)"
        (goToResearcher)="goToAgent.emit($event)"
        (goToImplementer)="goToAgent.emit($event)"
        (closed)="deselectTask()"
      />
    } @else {
    <!-- List view -->
    <div class="tasks-header">
      <h2 class="tasks-title">
        <mat-icon>assignment</mat-icon>
        Tasks
      </h2>
      <button mat-flat-button color="primary" (click)="startCreating()">
        <mat-icon>add</mat-icon>
        New Task
      </button>
      @if (githubAvailable) {
        <button mat-icon-button matTooltip="Import from GitHub Issues" (click)="openImportDialog()">
          <mat-icon>cloud_download</mat-icon>
        </button>
      }
    </div>

    <!-- State filter chips -->
    <div class="filter-bar">
      <button mat-stroked-button
              [class.active]="filterState() === null"
              (click)="setFilter(null)">
        All
      </button>
      @for (s of states; track s.id) {
        <button mat-stroked-button
                [class.active]="filterState() === s.id"
                [style.--chip-color]="s.color"
                (click)="setFilter(s.id)">
          <mat-icon [style.color]="s.color">{{ s.icon }}</mat-icon>
          {{ s.label }}
        </button>
      }
    </div>

    <!-- Kind filter chips -->
    <div class="filter-bar">
      <button mat-stroked-button
              [class.active]="filterKind() === null"
              (click)="setKindFilter(null)">
        All Kinds
      </button>
      @for (k of kinds; track k.id) {
        <button mat-stroked-button
                [class.active]="filterKind() === k.id"
                [style.--chip-color]="k.color"
                (click)="setKindFilter(k.id)">
          <mat-icon [style.color]="k.color">{{ k.icon }}</mat-icon>
          {{ k.label }}
        </button>
      }
    </div>

    <!-- Task list -->
    <div class="task-items">
      @if (loading()) {
        <div class="loading-state">
          <mat-icon class="spin">hourglass_empty</mat-icon>
          <span>Loading tasks...</span>
        </div>
      } @else if (tasks().length === 0) {
        <div class="empty-state">
          <mat-icon class="empty-icon">task_alt</mat-icon>
          <h3>No tasks yet</h3>
          <p>Create a task to get started</p>
        </div>
      } @else {
        @for (task of tasks(); track task.id) {
          <div class="task-card" (click)="selectTask(task)">
            <div class="task-card-left">
              <mat-icon class="kind-icon" [style.color]="getKindInfo(task.kind).color"
                        [matTooltip]="getKindInfo(task.kind).label">
                {{ getKindInfo(task.kind).icon }}
              </mat-icon>
              <mat-icon class="state-icon" [style.color]="getStateInfo(task.state).color">
                {{ getStateInfo(task.state).icon }}
              </mat-icon>
            </div>
            <div class="task-card-body">
              <div class="task-card-title">{{ task.title }}</div>
              @if (task.labels.length > 0 || task.researchContent || task.githubIssueNumber) {
                <div class="task-card-labels">
                  @if (task.researchContent) {
                    <span class="mini-label research-badge">
                      <mat-icon class="badge-icon">{{ task.kind === 'bug' ? 'bug_report' : 'science' }}</mat-icon>
                      {{ task.kind === 'bug' ? 'Diagnosed' : 'Researched' }}
                    </span>
                  }
                  @if (task.branchName) {
                    <span class="mini-label branch-badge">
                      <mat-icon class="badge-icon">account_tree</mat-icon>
                      {{ task.branchName }}
                    </span>
                  }
                  @if (task.prUrl) {
                    <span class="mini-label pr-badge">
                      <mat-icon class="badge-icon">merge</mat-icon>
                      PR #{{ task.prNumber || '' }}
                    </span>
                  }
                  @if (task.githubIssueNumber) {
                    <span class="mini-label github-badge">
                      <mat-icon class="badge-icon">link</mat-icon>
                      #{{ task.githubIssueNumber }}
                    </span>
                  }
                  @for (label of task.labels; track label.id) {
                    <span class="mini-label" [style.background-color]="label.color + '22'" [style.color]="label.color"
                          [style.border-color]="label.color + '44'">
                      {{ label.name }}
                    </span>
                  }
                </div>
              }
            </div>
            <div class="task-card-meta">
              <span class="task-card-state" [style.color]="getStateInfo(task.state).color">
                {{ getStateInfo(task.state).label }}
              </span>
            </div>
          </div>
        }
      }
    </div>
    }
  }
</div>
