<div class="task-detail">
  <!-- Header -->
  <div class="detail-header">
    <button mat-icon-button (click)="editing ? cancelEdit() : closed.emit()" matTooltip="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>

    @if (editing) {
      <mat-form-field appearance="outline" class="title-field">
        <input matInput [(ngModel)]="editTitle" placeholder="Task title" autofocus />
      </mat-form-field>
    } @else {
      <h2 class="task-title">{{ task()!.title }}</h2>
    }

    <div class="detail-actions">
      @if (editing) {
        <button mat-flat-button color="primary" [disabled]="!editTitle.trim()" (click)="save()">
          <mat-icon>check</mat-icon>
          {{ isCreating ? 'Create' : 'Save' }}
        </button>
        <button mat-button (click)="cancelEdit()">Cancel</button>
      } @else {
        <button mat-icon-button (click)="enterEditMode()" matTooltip="Edit">
          <mat-icon>edit</mat-icon>
        </button>
        <button mat-icon-button (click)="deleteRequested.emit(task()!)" matTooltip="Delete" class="delete-btn">
          <mat-icon>delete</mat-icon>
        </button>
      }
    </div>
  </div>

  <!-- Meta bar -->
  <div class="detail-meta">
    @if (editing) {
      <mat-form-field appearance="outline" class="state-field">
        <mat-label>State</mat-label>
        <mat-select [(ngModel)]="editState">
          @for (s of states; track s.id) {
            <mat-option [value]="s.id">
              <mat-icon [style.color]="s.color">{{ s.icon }}</mat-icon>
              {{ s.label }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="kind-field">
        <mat-label>Kind</mat-label>
        <mat-select [(ngModel)]="editKind">
          @for (k of kinds; track k.id) {
            <mat-option [value]="k.id">
              <mat-icon [style.color]="k.color">{{ k.icon }}</mat-icon>
              {{ k.label }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (labels().length > 0) {
        <mat-form-field appearance="outline" class="labels-field">
          <mat-label>Labels</mat-label>
          <mat-select [(ngModel)]="editLabelIds" multiple>
            @for (label of labels(); track label.id) {
              <mat-option [value]="label.id">
                <span class="label-dot" [style.background-color]="label.color"></span>
                {{ label.name }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      }
    } @else {
      <!-- State selector -->
      <button mat-stroked-button [matMenuTriggerFor]="stateMenu" class="state-chip"
              [style.border-color]="getStateInfo(task()!.state).color"
              [style.color]="getStateInfo(task()!.state).color">
        <mat-icon [style.color]="getStateInfo(task()!.state).color">{{ getStateInfo(task()!.state).icon }}</mat-icon>
        {{ getStateInfo(task()!.state).label }}
      </button>
      <mat-menu #stateMenu="matMenu">
        @for (s of states; track s.id) {
          @if (s.id === 'done' && task()!.kind === 'bug') {
            <button mat-menu-item [matMenuTriggerFor]="closeReasonMenu">
              <mat-icon [style.color]="s.color">{{ s.icon }}</mat-icon>
              <span>{{ s.label }}</span>
            </button>
          } @else {
            <button mat-menu-item (click)="onStateChange(s.id)">
              <mat-icon [style.color]="s.color">{{ s.icon }}</mat-icon>
              <span>{{ s.label }}</span>
            </button>
          }
        }
      </mat-menu>
      <mat-menu #closeReasonMenu="matMenu">
        @for (r of closeReasons; track r.id) {
          <button mat-menu-item (click)="onCloseBugWithReason(r.id)">
            <mat-icon>{{ r.icon }}</mat-icon>
            <span>{{ r.label }}</span>
          </button>
        }
      </mat-menu>

      <!-- Close reason badge (bugs only) -->
      @if (task()!.kind === 'bug' && task()!.state === 'done' && task()!.closeReason) {
        <span class="close-reason-badge">
          <mat-icon>{{ getCloseReasonInfo(task()!.closeReason!)?.icon }}</mat-icon>
          {{ getCloseReasonInfo(task()!.closeReason!)?.label }}
        </span>
      }

      <!-- Kind badge -->
      <span class="kind-badge"
            [style.border-color]="getKindInfo(task()!.kind).color"
            [style.color]="getKindInfo(task()!.kind).color">
        <mat-icon [style.color]="getKindInfo(task()!.kind).color">{{ getKindInfo(task()!.kind).icon }}</mat-icon>
        {{ getKindInfo(task()!.kind).label }}
      </span>

      @if (task()!.labels.length > 0) {
        <div class="label-chips">
          @for (label of task()!.labels; track label.id) {
            <span class="label-chip" [style.background-color]="label.color + '22'" [style.color]="label.color"
                  [style.border-color]="label.color + '44'">
              {{ label.name }}
            </span>
          }
        </div>
      }

      <span class="task-date">Created {{ task()!.createdAt | date:'medium' }}</span>

      <!-- GitHub Issue badge -->
      @if (task()!.githubIssueNumber) {
        <a class="github-issue-badge" [href]="getIssueUrl(task()!)" target="_blank" rel="noopener"
           matTooltip="Linked to GitHub Issue #{{ task()!.githubIssueNumber }}">
          <mat-icon>link</mat-icon>
          #{{ task()!.githubIssueNumber }}
        </a>
        <button mat-icon-button matTooltip="Unlink from GitHub Issue" (click)="unlinkFromGitHub()" class="unlink-btn">
          <mat-icon>link_off</mat-icon>
        </button>
      } @else if (githubAvailable()) {
        <button mat-stroked-button (click)="pushToGitHub()" [disabled]="pushingToGitHub" class="push-github-btn">
          <mat-icon>cloud_upload</mat-icon>
          {{ pushingToGitHub ? 'Pushing...' : 'Push to GitHub' }}
        </button>
      }
    }
  </div>

  <!-- Tabs: Description / Research (only when not creating) -->
  @if (!isCreating && !editing) {
    <mat-tab-group [(selectedIndex)]="activeTab" class="task-tabs" animationDuration="200ms">
      <!-- Description tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>description</mat-icon>
          <span class="tab-label-text">Description</span>
        </ng-template>
        <div class="tab-body">
          @if (task()!.description) {
            <div class="markdown-content" [innerHTML]="renderMarkdown(task()!.description)"></div>
          } @else {
            <p class="no-description">No description provided.</p>
          }
        </div>
      </mat-tab>

      <!-- Research / Diagnosis tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>{{ task()!.kind === 'bug' ? 'bug_report' : 'science' }}</mat-icon>
          <span class="tab-label-text">{{ task()!.kind === 'bug' ? 'Diagnosis' : 'Research' }}</span>
          @if (researchRunning() || reviewRunning()) {
            <mat-icon class="tab-spinner">sync</mat-icon>
          }
        </ng-template>
        <div class="tab-body">
          @if (task()!.researchContent) {
            <app-research-content
              [content]="task()!.researchContent!"
              [pendingComments]="pendingComments"
              (commentAdded)="addComment($event)"
              (commentRemoved)="removeComment($event)" />

            <!-- Review in progress indicator -->
            @if (reviewRunning()) {
              <div class="research-running">
                <mat-icon class="research-spinner">sync</mat-icon>
                <h3>Revising research based on your comments...</h3>
                <p>The agent is updating the document to address your review comments.</p>
                <button mat-stroked-button color="primary"
                        (click)="goToResearcher.emit(task()!.researchAgentId!)">
                  <mat-icon>open_in_new</mat-icon>
                  Take me to the Researcher
                </button>
              </div>
            } @else if (pendingComments.length > 0) {
              <div class="review-panel">
                <div class="review-panel-header">
                  <mat-icon>rate_review</mat-icon>
                  <span>{{ pendingComments.length }} pending comment{{ pendingComments.length > 1 ? 's' : '' }}</span>
                </div>

                <div class="review-comments-list">
                  @for (comment of pendingComments; track comment.id) {
                    <div class="review-comment-item">
                      <span class="comment-anchor-label">
                        {{ comment.anchor.blockType }}: "{{ comment.anchor.preview }}"
                      </span>
                      <span class="comment-body">{{ comment.body }}</span>
                      <button mat-icon-button (click)="removeComment(comment.id)">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  }
                </div>

                <div class="review-panel-actions">
                  <button mat-flat-button color="primary"
                          [disabled]="reviewSubmitting"
                          (click)="submitReview()">
                    <mat-icon>send</mat-icon>
                    Submit Review
                  </button>
                  <button mat-button
                          [disabled]="reviewSubmitting"
                          (click)="pendingComments = []">
                    Discard All
                  </button>
                </div>
              </div>
            }
          } @else if (researchRunning()) {
            <div class="research-running">
              <mat-icon class="research-spinner">sync</mat-icon>
              <h3>{{ task()!.kind === 'bug' ? 'Diagnosis in progress...' : 'Research in progress...' }}</h3>
              <p>The agent is analyzing this task. Results will appear here when complete.</p>
              <button mat-stroked-button color="primary" (click)="goToResearcher.emit(task()!.researchAgentId!)">
                <mat-icon>open_in_new</mat-icon>
                {{ task()!.kind === 'bug' ? 'Take me to the Debugger' : 'Take me to the Researcher' }}
              </button>
            </div>
          } @else {
            <!-- Start research/diagnosis UI -->
            <div class="research-empty">
              <mat-icon class="research-icon">{{ task()!.kind === 'bug' ? 'bug_report' : 'science' }}</mat-icon>
              <h3>{{ task()!.kind === 'bug' ? 'No diagnosis yet' : 'No research yet' }}</h3>
              <p>{{ task()!.kind === 'bug' ? 'Assign an agent to diagnose this bug. The diagnosis will be appended to the task description.' : 'Assign an agent to research this task. The output will be saved as a markdown document.' }}</p>

              <div class="research-start-form">
                <mat-form-field appearance="outline" class="agent-picker">
                  <mat-label>Agent</mat-label>
                  <mat-select [(ngModel)]="selectedResearchAgentId">
                    <mat-select-trigger>
                      @if (getAgentById(selectedResearchAgentId); as agent) {
                        <span class="agent-option"><app-agent-icon [icon]="agent.icon" /> {{ agent.name }}</span>
                      }
                    </mat-select-trigger>
                    @if (task()!.kind === 'bug' && debugAgents.length > 0) {
                      <mat-optgroup label="Debug Agents">
                        @for (a of debugAgents; track a.id) {
                          <mat-option [value]="a.id">
                            <span class="agent-option"><app-agent-icon [icon]="a.icon" /> {{ a.name }}</span>
                          </mat-option>
                        }
                      </mat-optgroup>
                    }
                    @if (researchAgents.length > 0) {
                      <mat-optgroup label="Research Agents">
                        @for (a of researchAgents; track a.id) {
                          <mat-option [value]="a.id">
                            <span class="agent-option"><app-agent-icon [icon]="a.icon" /> {{ a.name }}</span>
                          </mat-option>
                        }
                      </mat-optgroup>
                    }
                    @if (codingAgents.length > 0) {
                      <mat-optgroup label="Other Agents">
                        @for (a of codingAgents; track a.id) {
                          <mat-option [value]="a.id">
                            <span class="agent-option"><app-agent-icon [icon]="a.icon" /> {{ a.name }}</span>
                          </mat-option>
                        }
                      </mat-optgroup>
                    }
                  </mat-select>
                </mat-form-field>

                <button mat-flat-button color="primary"
                        [disabled]="!selectedResearchAgentId"
                        (click)="startResearch()">
                  <mat-icon>play_arrow</mat-icon>
                  {{ task()!.kind === 'bug' ? 'Start Diagnosis' : 'Start Research' }}
                </button>
              </div>
            </div>
          }
        </div>
      </mat-tab>

      <!-- Implementation tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>build</mat-icon>
          <span class="tab-label-text">Implementation</span>
          @if (implementRunning()) {
            <mat-icon class="tab-spinner">sync</mat-icon>
          }
        </ng-template>
        <div class="tab-body">
          @if (implementRunning()) {
            <div class="research-running">
              <mat-icon class="research-spinner">sync</mat-icon>
              <h3>{{ lifecycleLabel || 'Implementation in progress...' }}</h3>
              <p>The agent is implementing this task. You can watch its progress live.</p>
              @if (lifecycleWarning) {
                <div class="lifecycle-warning">
                  <mat-icon>warning</mat-icon>
                  <span>{{ lifecycleWarning }}</span>
                </div>
              }
              @if (task()!.branchName) {
                <div class="branch-info">
                  <mat-icon>account_tree</mat-icon>
                  <span class="branch-name">{{ task()!.branchName }}</span>
                </div>
              }
              @if (lifecyclePhase) {
                <div class="lifecycle-steps">
                  <span class="step" [class.active]="lifecyclePhase === 'creating_worktree'" [class.done]="isPhaseAfter('creating_worktree')">
                    <mat-icon>{{ phaseIcon('creating_worktree') }}</mat-icon> Worktree
                  </span>
                  <span class="step" [class.active]="lifecyclePhase === 'installing_deps'" [class.done]="isPhaseAfter('installing_deps')">
                    <mat-icon>{{ phaseIcon('installing_deps') }}</mat-icon> Deps
                  </span>
                  <span class="step" [class.active]="lifecyclePhase === 'implementing'" [class.done]="isPhaseAfter('implementing')">
                    <mat-icon>{{ phaseIcon('implementing') }}</mat-icon> Implement
                  </span>
                  <span class="step" [class.active]="lifecyclePhase === 'evaluating'" [class.done]="isPhaseAfter('evaluating')">
                    <mat-icon>{{ phaseIcon('evaluating') }}</mat-icon> Evaluate
                  </span>
                  <span class="step" [class.active]="lifecyclePhase === 'committing'" [class.done]="isPhaseAfter('committing')">
                    <mat-icon>{{ phaseIcon('committing') }}</mat-icon> Commit
                  </span>
                  <span class="step" [class.active]="lifecyclePhase === 'creating_pr'">
                    <mat-icon>{{ phaseIcon('creating_pr') }}</mat-icon> PR
                  </span>
                </div>
              }
              <button mat-stroked-button color="primary" (click)="goToImplementer.emit(task()!.implementAgentId || selectedImplementAgentId)">
                <mat-icon>open_in_new</mat-icon>
                Take me to the Agent
              </button>
            </div>
          } @else if ((task()!.state === 'done' || task()!.state === 'review') && task()!.implementAgentId) {
            <div class="implementation-complete">
              @if (task()!.state === 'review') {
                <mat-icon class="complete-icon" style="color: #06b6d4">rate_review</mat-icon>
                <h3>Ready for Review</h3>
                <p>The agent has implemented and self-evaluated this task. Please review the PR.</p>
              } @else {
                <mat-icon class="complete-icon">check_circle</mat-icon>
                <h3>Implementation Complete</h3>
                <p>The agent has finished implementing this task.</p>
              }

              @if (task()!.branchName) {
                <div class="branch-info">
                  <mat-icon>account_tree</mat-icon>
                  <span class="branch-name">{{ task()!.branchName }}</span>
                </div>
              }

              <!-- PR status badge -->
              @if (task()!.prUrl) {
                <div class="pr-status-badge" [style.border-color]="getPRStateInfo(task()!.prState || 'open').color">
                  <mat-icon [style.color]="getPRStateInfo(task()!.prState || 'open').color">{{ getPRStateInfo(task()!.prState || 'open').icon }}</mat-icon>
                  <a [href]="task()!.prUrl" target="_blank" rel="noopener">
                    PR #{{ task()!.prNumber || '' }} — {{ getPRStateInfo(task()!.prState || 'open').label }}
                  </a>
                </div>
              }

              <div class="implementation-actions">
                <button mat-stroked-button color="primary"
                        (click)="goToImplementer.emit(task()!.implementAgentId!)">
                  <mat-icon>open_in_new</mat-icon>
                  View Agent Conversation
                </button>

                @if (task()!.worktreePath && !task()!.prUrl) {
                  <button mat-stroked-button
                          [disabled]="loadingDiff"
                          (click)="loadDiffPreview()">
                    <mat-icon>difference</mat-icon>
                    {{ loadingDiff ? 'Loading...' : 'Preview Diff' }}
                  </button>

                  <button mat-flat-button color="primary"
                          [disabled]="prCreating"
                          (click)="createPR()">
                    <mat-icon>merge</mat-icon>
                    {{ prCreating ? 'Creating...' : 'Create Pull Request' }}
                  </button>
                }

                <button mat-flat-button color="warn"
                        (click)="requestRevision()">
                  <mat-icon>replay</mat-icon>
                  Request Revision
                </button>

                @if (task()!.state === 'review') {
                  <button mat-flat-button color="primary" (click)="markDone()">
                    <mat-icon>check_circle</mat-icon>
                    Approve &amp; Mark Done
                  </button>
                }
              </div>

              <!-- Diff preview panel -->
              @if (showDiffPreview && diffSummary) {
                <div class="diff-preview">
                  <div class="diff-header">
                    <mat-icon>difference</mat-icon>
                    <strong>Diff Preview</strong>
                    <button mat-icon-button (click)="showDiffPreview = false">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                  <pre class="diff-summary">{{ diffSummary }}</pre>
                </div>
              }

              @if (prUrl) {
                <div class="pr-success">
                  <mat-icon>check_circle</mat-icon>
                  <span>PR created: <a [href]="prUrl" target="_blank" rel="noopener">{{ prUrl }}</a></span>
                </div>
              }
              @if (prError) {
                <div class="pr-error">
                  <mat-icon>error</mat-icon>
                  <span>{{ prError }}</span>
                </div>
              }
            </div>
          } @else {
            <div class="research-empty">
              <mat-icon class="research-icon">build</mat-icon>
              <h3>Implement this task</h3>

              @if (!task()!.researchContent) {
                <div class="implement-warning">
                  <mat-icon>warning</mat-icon>
                  <span>This task hasn't been researched yet. Research first for better implementation results.</span>
                </div>
              }

              <p>Select an agent to implement the changes for this task.</p>

              <div class="research-start-form">
                <mat-form-field appearance="outline" class="agent-picker">
                  <mat-label>Agent</mat-label>
                  <mat-select [(ngModel)]="selectedImplementAgentId">
                    <mat-select-trigger>
                      @if (getAgentById(selectedImplementAgentId); as agent) {
                        <span class="agent-option"><app-agent-icon [icon]="agent.icon" /> {{ agent.name }}</span>
                      }
                    </mat-select-trigger>
                    @if (codingAgents.length > 0) {
                      <mat-optgroup label="Coding Agents">
                        @for (a of codingAgents; track a.id) {
                          <mat-option [value]="a.id">
                            <span class="agent-option"><app-agent-icon [icon]="a.icon" /> {{ a.name }}</span>
                          </mat-option>
                        }
                      </mat-optgroup>
                    }
                    @if (researchAgents.length > 0) {
                      <mat-optgroup label="Research Agents">
                        @for (a of researchAgents; track a.id) {
                          <mat-option [value]="a.id">
                            <span class="agent-option"><app-agent-icon [icon]="a.icon" /> {{ a.name }}</span>
                          </mat-option>
                        }
                      </mat-optgroup>
                    }
                  </mat-select>
                </mat-form-field>

                <button mat-flat-button color="primary"
                        [disabled]="!selectedImplementAgentId"
                        (click)="startImplementation()">
                  <mat-icon>play_arrow</mat-icon>
                  Start Implementation
                </button>
              </div>
            </div>
          }
        </div>
      </mat-tab>
    </mat-tab-group>
  } @else {
    <!-- Editing / Creating — no tabs, just the description editor -->
    <div class="detail-body">
      <mat-form-field appearance="outline" class="description-field">
        <mat-label>Description (Markdown)</mat-label>
        <textarea matInput [(ngModel)]="editDescription" rows="20" placeholder="Describe the task..."></textarea>
      </mat-form-field>
    </div>
  }
</div>
